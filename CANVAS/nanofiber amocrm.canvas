{
	"nodes":[
		{"type":"group","id":"3729d75fcf3d76d6","x":-2720,"y":-12000,"width":16960,"height":18400,"color":"4","label":"centr-polov"},
		{"type":"group","id":"e661cf98f3607f51","x":720,"y":-8000,"width":12280,"height":14320,"label":"/upload"},
		{"type":"group","id":"9cbc93d33bcb0bcf","x":-2660,"y":-11860,"width":3180,"height":10960,"label":"/bitrix"},
		{"type":"group","id":"cf3252b211ad1b64","x":-2600,"y":-11740,"width":3080,"height":10800,"label":"/php_interface"},
		{"type":"group","id":"40c24330222da4f2","x":-2540,"y":-11600,"width":2980,"height":10620,"label":"init.php"},
		{"type":"group","id":"9aa387c3defe5307","x":-6240,"y":-11280,"width":3280,"height":2760,"color":"1","label":"1C BITRIX"},
		{"type":"group","id":"2f1b4a431b0c9ca7","x":1920,"y":-9680,"width":6640,"height":1080,"label":"/amo_integration"},
		{"type":"group","id":"ac29084e67f2a107","x":14560,"y":-9590,"width":720,"height":560,"color":"1","label":"AMOCRM"},
		{"type":"group","id":"a25aec4d49dd13e6","x":800,"y":-7840,"width":12120,"height":14080,"label":"/amo_new"},
		{"type":"group","id":"794c9181357cedd7","x":890,"y":-7680,"width":11950,"height":13840,"label":"amocrm_api.php"},
		{"type":"group","id":"a83c0f20b7668064","x":1980,"y":-9560,"width":6540,"height":900,"label":"control_integration.php"},
		{"type":"group","id":"b9053a8e15b2adb7","x":-6800,"y":-8000,"width":2200,"height":1785,"color":"6","label":"xl-pipe"},
		{"type":"group","id":"ad3ee67bcb7656b5","x":-6760,"y":-7855,"width":2120,"height":1600,"label":"include"},
		{"type":"group","id":"260725635bec8a96","x":-6720,"y":-7735,"width":2040,"height":1440,"label":"email_messengers.php"},
		{"type":"group","id":"7e04312a3e8a8c13","x":-9600,"y":-6095,"width":1258,"height":751,"color":"1","label":"$_POST"},
		{"type":"text","text":"```php\n//Данные для отправки лида в АМОСРМ\n\n  \n  \n\n//Город\n\nif ($city === 'Тверь'){\n\n    $boss_city = $city;\n\n  \n\n//Эмаил\n\n$boss_email = htmlspecialchars($_REQUEST[\"boss_email\"], ENT_QUOTES);\n\n  \n\n//email пользователя из формы\n\n// $_POST[\"email\"]=$email;\n\n  \n\n//Телефон\n\n$_REQUEST[\"user_phone\"] = $phone;\n\n  \n\n//Субдомен AMO:\n\n$subd_amo = 'palkov';\n\n  \n\n//Идентификатор интеграции:\n\n$id_amo = '861c7bc9-d9f4-4aae-a8cb-03440bc3db1c';\n\n  \n\n//Секретный ключ интеграции:\n\n$secretkey_amo = 'iI18mnHqAZ0BZ77915il2xcJC7gQqwS8bBkOb54wAbb93ciIWqLPmSZfOsE0xriW';\n\n  \n\n//Включение/выключение интеграции:\n\n$add_integrations_amo = 'Y';\n\n  \n\n//Включение/выключение получения refrash токена:\n\n$add_refresh_amo = 'N';\n\n  \n\n//Сам refrash токен (живет либо 20 минут, либо 1 раз)\n\n$refresh_amo = '';\n\n  \n\n//ID ответственного пользователя\n\n$responsible_user_id = '6506587';\n\n  \n\n//ID воронки отправки\n\n$status_id = 55015598;\n\n  \n\n//IP лида\n\n$iplead = $_SERVER['HTTP_X_REAL_IP'];\n\n  \n\n//URL лида\n\n$urllead = urldecode($_SERVER['HTTP_REFERER']);\n\n  \n\n//Город лида\n\n$citylead = $city;\n\n  \n\n//Имя лида\n\n$namelead = $leadphone . \", \" . $_REQUEST['subject'];\n\n  \n\n//Тэги\n\n$tag = $_SERVER['HTTP_HOST'];\n\n  \n\n//Комментарии\n\n$message_comment = str_replace(array('<br>', '<br />'), ', ', $message);\n\n  \n\n$utm_metka_dirty = parse_url($_SERVER['HTTP_REFERER']);\n\nparse_str($utm_metka_dirty['query'], $utm_metka);\n\n  \n\n$utm_source = $utm_metka['utm_source'];\n\n$utm_medium = $utm_metka['utm_medium'];\n\n$utm_campaign = $utm_metka['utm_campaign'];\n\n$utm_term = $utm_metka['utm_term'];\n\n$utm_content = $utm_metka['utm_content'];\n\n  \n\n$utm_source_stroke = '998251';\n\n$utm_medium_stroke = '998253';\n\n$utm_campaign_stroke = '998255';\n\n$utm_term_stroke = '998257';\n\n$utm_content_stroke = '998259';\n\n  \n\nif (!$utm_metka['utm_source']) {\n\n    $utmss = '';\n\n} else {\n\n    $utmss = +', rk_' . $utm_metka['utm_source'];\n\n}\n\n  \n\n$s_tags = 'oA2, наносетка.рф' . $utmss;\n\n}else{\n\n    $boss_city = $city;\n\n  \n\n    //Эмаил\n\n    $boss_email = htmlspecialchars($_REQUEST[\"boss_email\"], ENT_QUOTES);\n\n    //email пользователя из формы\n\n    // $_POST[\"email\"]=$email;\n\n    //Телефон\n\n    $_REQUEST[\"user_phone\"] = $phone;\n\n    //Субдомен AMO:\n\n    $subd_amo = 'envo';\n\n    //Идентификатор интеграции:\n\n    $id_amo = '68d618b9-3428-420a-abf9-93e028dfc19a';\n\n    //Секретный ключ интеграции:\n\n    $secretkey_amo = 'hnudLBYmxLVTEl4J6QyEuCw0YkvNiqhZtSaSlzzpcsyO5WQa6nJ1jQeOTKWPmF4s';\n\n    //Включение/выключение интеграции:\n\n    $add_integrations_amo = 'Y';\n\n    //Включение/выключение получения refrash токена:\n\n    $add_refresh_amo = 'N';\n\n    //Сам refrash токен (живет либо 20 минут, либо 1 раз)\n\n    $refresh_amo = 'def50200d8076a199df8537cf19dcd8cfff41af0f4685112507a32166ac91d9e79e34afa926b2f8c98b664f5a7055cfe62aec6fa8b1924463aa93cfca05716a2ce924f80135bf6116dce30952f1d2698c0644585285fc56a0a06e5b3d45d20a0d84f2ce81afc7911e6b64a8aed4106f0cbe40491c325936e9f551b3e28655a1b26d8ff71770c3297c6247c6503e8fd240f498acbb24113d0451ac6d84c4510f770a68dcc50078f076ddd736fd8230d9cbcf48d63031aca9cd74100e61aeb35fb1a3ee1bca9bdf92b7a2fcc72fc3f4e1b8dbd8ec2f7fe970fecf4f5e9733f94293e42665f6b0758a0b7c0147a0193229a6a50bb15daf1510f4a30609a908fb2f0a6d9341cf346f53daddaad646afb650b5f4cb25a027484502181b35604533c5e971c94bb3fcc6b3079488367a9795981a9627121901903303b772c56da71efe7bc8a1b60372160deae5249d2bc7369f431bb06f2f67deed9a5f2d30f5d7cf3896521f4122730b431582c60e92fd9e71ecb0e74d7857df4071913db09a58bcf8e5e2ebe6ecda4069b587623bc20e30ce78360eb1ea562fcae4b5391f9df0a13cb8a40bf571dbf8679377a0e7adcea38d1e1314277a370423919779c7984e8a4696efd37161783552c';\n\n    //ID ответственного пользователя\n\n    $responsible_user_id = '3918751';\n\n    //ID воронки отправки\n\n    $status_id = '48796813';\n\n    //IP лида\n\n    $iplead = $_SERVER[HTTP_X_REAL_IP];\n\n    //URL лида\n\n    $urllead = urldecode($_SERVER[HTTP_REFERER]);\n\n    //Город лида\n\n    $citylead = $city;\n\n    //Имя лида\n\n    $namelead = $leadphone . \", \" . $_REQUEST['subject'];\n\n    //Тэги\n\n    $tag = $_SERVER['HTTP_HOST'];\n\n    //Комментарии\n\n    $message_comment = str_replace(array('<br>', '<br />'), ', ', $message);\n\n    $utm_metka_dirty = parse_url($_SERVER['HTTP_REFERER']);\n\n    parse_str($utm_metka_dirty['query'], $utm_metka);\n\n    $utm_source = $utm_metka['utm_source'];\n\n    $utm_medium = $utm_metka['utm_medium'];\n\n    $utm_campaign = $utm_metka['utm_campaign'];\n\n    $utm_term = $utm_metka['utm_term'];\n\n    $utm_content = $utm_metka['utm_content'];\n\n    $utm_source_stroke = '486801';\n\n    $utm_medium_stroke = '486803';\n\n    $utm_campaign_stroke = '486805';\n\n    $utm_term_stroke = '486807';\n\n    $utm_content_stroke = '490399';\n\n    if (!$utm_metka['utm_source']) {\n\n        $utmss = '';\n\n    } else {\n\n        $utmss = +', rk_' . $utm_metka['utm_source'];\n\n    }\n\n    $s_tags = 'oA2, наносетка.рф' . $utmss;\n\n}\n\n  \n\n?>\n\n  \n\n<?\n\nif ($add_integrations_amo == 'Y') {\n\n  \n\n    require($_SERVER[\"DOCUMENT_ROOT\"] . \"/upload/amo_integration/control_integration.php\");\n\n} else {\n\n  \n\n    $city = $_REQUEST['boss_city'];\n\n    $_REQUEST['email'] = $_REQUEST['user_email'];\n\n  \n\n    require($_SERVER[\"DOCUMENT_ROOT\"] . \"/upload/forms_to_amocrm.php\");\n\n    //sendTelegram($_SERVER[\"DOCUMENT_ROOT\"]);\n\n}\n```","id":"3ab62cf10dd62003","x":-11920,"y":-9600,"width":1261,"height":8355},
		{"type":"text","text":"выполняет следующие действия:\n\n1. Принимает следующие параметры: $subd_amo, $secretkey_amo, $id_amo, $redirect_urls, $refresh_amo.\n2. Читает информацию о токене из файла \"token_\" . $subd_amo . \".json\".\n3. Формирует URL-адрес для получения токена доступа в АМО CRM.\n4. Создает массив $data, содержащий необходимые параметры для запроса на получение нового токена доступа.\n5. Использует cURL для отправки POST-запроса на указанный URL-адрес с передачей параметров в виде JSON-строки.\n6. Получает ответ от сервера и декодирует его из JSON в ассоциативный массив.\n7. Если возникает ошибка при получении токена, вызывается функция sendTelegramFormErrorAmo(), которая отправляет сообщение об ошибке в Telegram с деталями ошибки и информацией о запросе и ответе на сервере.\n8. Если удалось успешно получить токен доступа, сохраняет его и другие данные связанные с токеном в подключенный файл.\n9. Возвращает полученный токен доступа ($access_token) для дальнейшего использования в коде.\n\n\n```php\nfunction gettingRefreshTokenAmo($subd_amo, $secretkey_amo, $id_amo, $redirect_urls, $refresh_amo) {\n\n  \n\n    $token_info = json_decode(file_get_contents($_SERVER[\"DOCUMENT_ROOT\"] .'/upload//amo_integration/amonew/tokens/token_' . $subd_amo . '.json'));\n\n  \n\n    $link = 'https://' . $subd_amo . '.amocrm.ru/oauth2/access_token';\n\n    $data = array(\n\n    'client_id' => $id_amo,\n\n    'client_secret' => $secretkey_amo,\n\n    'grant_type' => 'authorization_code',\n\n    'code' => $refresh_amo,\n\n    'redirect_uri' => $redirect_urls\n\n    );\n\n  \n\n    //$token_info->refresh_token\n\n  \n\n    $curl = curl_init();\n\n    curl_setopt($curl,CURLOPT_RETURNTRANSFER, true);\n\n    curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');\n\n    curl_setopt($curl,CURLOPT_URL, $link);\n\n    curl_setopt($curl,CURLOPT_HTTPHEADER,['Content-Type:application/json']);\n\n    curl_setopt($curl,CURLOPT_HEADER, false);\n\n    curl_setopt($curl,CURLOPT_CUSTOMREQUEST, 'POST');\n\n    curl_setopt($curl,CURLOPT_POSTFIELDS, json_encode($data));\n\n    curl_setopt($curl,CURLOPT_SSL_VERIFYPEER, 1);\n\n    curl_setopt($curl,CURLOPT_SSL_VERIFYHOST, 2);\n\n    $out = curl_exec($curl);\n\n    $response = json_decode($out, true);\n\n  \n\n    sendTelegramFormErrorAmo($amo_error_send_token = 'Ошибка получения токена для аккаунта ' . $subd_amo . \"\\nСтатус ошибки:   \" . $response['status'] . \"\\nХинт:   \" . $response['hint'] . \"\\nДетализация ошибки:   \" . $response['detail'] . \"\\n\\nТело запроса:\\n\" . serialize($data) . \"\\nТело ответа:\\n\" . serialize($response) . \"\\n\\nСайт:\\n\" . $_SERVER['HTTP_REFERER']);\n\n    $access_token = $response['access_token'];\n\n    $refresh_token = $response['refresh_token'];\n\n    $token_type = $response['token_type'];\n\n    $expires_in = $response['expires_in'];\n\n  \n\n    if ($access_token){\n\n  \n\n        $data_amocrm = array('access_token' => $access_token,'expires' => $expires_in,'refresh_token' => $refresh_token);\n\n  \n\n        //При получении перезаписываем в подключенный файл\n\n        writeJsonToFilesAmoCRM($data_amocrm, $subd_amo);\n\n    }\n\n  \n\n    return $access_token;\n\n  \n\n}\n```","id":"2d6c4c134b921da2","x":960,"y":-7600,"width":3840,"height":2860},
		{"type":"text","text":"```php\n<?\n\n  \n\n//Отправка лида в AMOCRM\n\n$redirect_urls = 'https://amocrmapi.ru/auth.php';\n\n//Получение токена обновления токена доступа\n\n//$access_token = gettingRefreshTokenAmo($subdomain, $client_secrets, $client_id, $redirect_urls);\n\n//Получение токена доступа\n\n  \n\nif ($add_refresh_amo == 'Y') {\n\n    $access_token = gettingRefreshTokenAmo($subd_amo, $secretkey_amo, $id_amo, $redirect_urls, $refresh_amo, $message, $_SERVER['HTTP_REFERER'], $phone);\n\n} else {\n\n    $access_token = gettingAccessTokenAmo($subd_amo, $secretkey_amo, $id_amo, $redirect_urls, $message, $message_comment, $_SERVER['HTTP_REFERER'], $phone);\n\n}\n```","id":"63c8819e09173d40","x":2040,"y":-9480,"width":1725,"height":760,"color":"1"},
		{"type":"text","text":"Собираем все остальные данные и помещаем их в функцию preparationAMO();\n\n```php\npreparationAMO($city,$_POST[\"user_email\"],$_POST[\"user_phone\"],$_POST[\"user_city\"],$_POST[\"subject\"],$_POST[\"type\"],$message_comment,$_POST[\"user_name\"],$dataPROPS,$generaldata);\n```","id":"677bf3139db6fd8e","x":-6686,"y":-6535,"width":1966,"height":160,"color":"1"},
		{"type":"text","text":"```php\nfunction writeDebug($text) {\n\n    $json = $text;\n\n    $file = fopen('/var/www/html/nanofiber.info/include/debug.json','w+');\n\n    fwrite($file, $json);\n\n    fclose($file);\n\n}\n```","id":"d452793147cb0ba3","x":7440,"y":-2840,"width":990,"height":425},
		{"type":"text","text":"```php\nsendForAmoCrm($access_token, $phone, $responsible_user_id, $status_id, $id_amo, $secretkey_amo, $subd_amo, $iplead, $urllead, $citylead, $nameleadm, $tag, $comments, $message, $utm_source, $utm_medium, $utm_campaign, $utm_term, $utm_content, $utm_source_stroke, $utm_medium_stroke, $utm_campaign_stroke, $utm_term_stroke, $utm_content_stroke, $s_tags, $message_comment);\n\n```","id":"1e2f057bcc870e21","x":4420,"y":-9160,"width":4045,"height":120,"color":"1"},
		{"type":"text","text":"```php\nfunction gettingAccessTokenAmo($subd_amo, $secretkey_amo, $id_amo, $redirect_urls,$message,$message_comment,$phone) {\n\n  \n\n    $token_info = json_decode(file_get_contents($_SERVER[\"DOCUMENT_ROOT\"] .'/upload/amo_integration/amonew/tokens/token_' . $subd_amo . '.json'));\n\n  \n\n    if(!$token_info){\n\n        $text_error_token = 'Отсутствует токен доступа для субдомена ' . $subd_amo . \"\\nЗапрос с сайта: \" . $_SERVER['HTTP_HOST'] . \"\\nТелефон: \" . $phone;\n\n        sendTelegramFormErrorAmo($text_error_token);\n\n    }\n\n  \n  \n\n    $link = 'https://' . $subd_amo . '.amocrm.ru/oauth2/access_token';\n\n    $data = array(\n\n    'client_id' => $id_amo,\n\n    'client_secret' => $secretkey_amo,\n\n    'grant_type' => 'refresh_token',\n\n    'refresh_token' => $token_info->refresh_token,\n\n    'redirect_uri' => $redirect_urls\n\n    );\n\n  \n\n    $curl = curl_init();\n\n    curl_setopt($curl,CURLOPT_RETURNTRANSFER, true);\n\n    curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-oAuth-client/1.0');\n\n    curl_setopt($curl,CURLOPT_URL, $link);\n\n    curl_setopt($curl,CURLOPT_HTTPHEADER,['Content-Type:application/json']);\n\n    curl_setopt($curl,CURLOPT_HEADER, false);\n\n    curl_setopt($curl,CURLOPT_CUSTOMREQUEST, 'POST');\n\n    curl_setopt($curl,CURLOPT_POSTFIELDS, json_encode($data));\n\n    curl_setopt($curl,CURLOPT_SSL_VERIFYPEER, 1);\n\n    curl_setopt($curl,CURLOPT_SSL_VERIFYHOST, 2);\n\n    $out = curl_exec($curl);\n\n    $response = json_decode($out, true);\n\n    //sendTelegramFormErrorAmo(serialize($response));\n\n  \n\n    if($response['status']){\n\n        $amo_error_send_token = 'Ошибка получения токена для аккаунта ' . $subd_amo . \"\\nСтатус ошибки:   \" . $response['status'] . \"\\nХинт:   \" . $response['hint'] . \"\\nДетализация ошибки:   \" . $response['detail'] . \"\\n\\nТело запроса:\\n\" . serialize($data) . \"\\nТело ответа:\\n\" . serialize($response) . \"\\n\\nСайт:\\n\" . $_SERVER['HTTP_REFERER'];\n\n        sendTelegramFormErrorAmo($amo_error_send_token);\n\n    }\n\n  \n  \n\n    $access_token = $response['access_token'];\n\n    $refresh_token = $response['refresh_token'];\n\n    $token_type = $response['token_type'];\n\n    $expires_in = $response['expires_in'];\n\n  \n\n    if ($access_token){\n\n  \n\n        $data_amocrm = array('access_token' => $access_token,'expires' => $expires_in,'refresh_token' => $refresh_token);\n\n  \n\n        //При получении перезаписываем в подключенный файл\n\n        writeJsonToFilesAmoCRM($data_amocrm, $subd_amo);\n\n    }\n\n  \n\n    return $access_token;\n\n  \n\n}\n```","id":"c39630510efe853c","x":4920,"y":-7520,"width":3600,"height":2880},
		{"type":"text","text":"Создаем message_comment - сообщение о лиде(указанные им в формах данные, ip)\n```php\n$message_comment = \"Уникальный идентификатор посетителя - \".\n\n$_SERVER[HTTP_X_REAL_IP].\"\\nГород: \".$city.\n\n\"\\n\".$_POST[\"subject\"].\n\n\"\\nТелефон: \".$_POST[\"user_phone\"].\n\n\"\\nE-mail: \".$_POST[\"user_email\"].\n\n\"\\nСпособ отправки: \".$_POST[\"type\"];\n\n\n\n```\n","id":"d40f94022dbd653e","x":-6640,"y":-7215,"width":686,"height":500,"color":"1"},
		{"type":"text","text":"```php\n<?php\n\n//Запись в json\n\nfunction writeJsonToFilesAmoCRM($data_amocrm, $subd_amo)\n\n{\n\n  \n\n    $str = str_replace('\"', '', $subd_amo);\n\n    $json = json_encode($data_amocrm);\n\n    $file = fopen($_SERVER[\"DOCUMENT_ROOT\"] .'/upload/amo_integration/amonew/tokens/token_' . $str . '.json','w+');\n\n    fwrite($file, $json);\n\n    fclose($file);\n\n  \n\n}\n```","id":"b00018ae4b2fda6e","x":4360,"y":-4280,"width":1320,"height":680},
		{"type":"text","text":"```php\nfunction sendTelegramFormErrorAmo($text)\n\n{\n\n    $ch = curl_init();\n\n    curl_setopt_array(\n\n        $ch,\n\n        array(\n\n            CURLOPT_URL => 'https://api.telegram.org/bot1920317552:AAEcdlCY-NQcuJiWO9MJ7JMM6C2re1YuaAE/sendMessage',\n\n            // CURLOPT_URL => 'https://api.telegram.org/bot5970971353:AAHyyXHLAMyC86oIiUREWrMNk8baHoYYZ4E/sendMessage',\n\n            CURLOPT_POST => TRUE,\n\n            CURLOPT_RETURNTRANSFER => TRUE,\n\n            CURLOPT_TIMEOUT => 10,\n\n            CURLOPT_POSTFIELDS => array(\n\n                // 'chat_id' => -622622854,\n\n                'chat_id' => 233617089,\n\n                'text' => $text,\n\n            ),\n\n        )\n\n    );\n\n    curl_exec($ch);\n\n}\n```","id":"6cb52bdcb38d70f0","x":4225,"y":-2415,"width":1591,"height":1090},
		{"type":"text","text":"```php\nfunction sendForAmoCrm($access_token, $phone, $responsible_user_id, $status_id, $id_amo, $secretkey_amo, $subd_amo, $iplead, $urllead, $citylead, $nameleadm, $tag, $comments, $message,$utm_source, $utm_medium, $utm_campaign, $utm_term, $utm_content, $utm_source_stroke, $utm_medium_stroke, $utm_campaign_stroke, $utm_term_stroke, $utm_content_stroke,$s_tags,$message_comment){\n\n        $headers = array('Authorization: Bearer ' . $access_token,\"Content-Type: application/json\");\n\n  \n\n        if (isset($_COOKIE['visitor_uid'])){\n\n            $visitor_uid=$_COOKIE['visitor_uid'];\n\n        }\n\n  \n\n        if ($_POST['city']){$city = $_POST['city'];}\n\n        if ($_POST['boss_city']){$city = $_POST['boss_city'];}\n\n        $iplead = $_SERVER[HTTP_X_REAL_IP];\n\n        $urllead = $_SERVER[HTTP_REFERER];\n\n  \n\n        if(strlen($city) == '0'){\n\n            $citylead = $citylead;\n\n        } else {\n\n            $citylead = $city;\n\n        }\n\n        //$namelead = $citylead.\", \".$phone.\", \".$subject;\n\n        $tag = $_SERVER['HTTP_HOST'];\n\n  \n  \n  \n\n        $comments = $message_comment  . \"\\n\\nПолный URL:\\n\" . $_SERVER['HTTP_REFERER'];\n\n        $messagelead = $message_comment;\n\n  \n\n        if ($_POST[\"name\"]){$name = $_POST[\"name\"];}\n\n        if ($_POST[\"email\"]){$email = $_POST[\"email\"];}\n\n        if ($_POST[\"user_email\"]){$email = $_POST[\"user_email\"];}\n\n        if ($_POST[\"user_phone\"]){$phone = $_POST[\"user_phone\"];}\n\n  \n\n        $namelead = $phone . ', ' . $citylead . ', ' . $_POST[\"subject\"];  \n\n        $sdelka=array(\n\n            'name'=>$namelead,\n\n            'status_id'=>$status_id,\n\n            'price'=>$summ,\n\n            'responsible_user_id'=>$responsible_user_id,\n\n            //'tags'=>$tag.','.$citylead.',oAuth2.0',\n\n            'tags'=> $s_tags,\n\n            'visitor_uid'=>$visitor_uid\n\n        );\n\n  \n\n        if ($city){$sdelka['custom_fields'][]=array('id'=>1008489,'values'=>array(array('value'=>$city)));}\n\n        if ($iplead){$sdelka['custom_fields'][]=array('id'=>1008569,'values'=>array(array('value'=>$iplead)));}\n\n        if ($urllead){$sdelka['custom_fields'][]=array('id'=>1008567,'values'=>array(array('value'=>$urllead)));}\n\n        if ($messagelead){$sdelka['custom_fields'][]=array('id'=>1008475,'values'=>array(array('value'=>$messagelead)));}\n\n  \n  \n\n        if ($utm_source){$sdelka['custom_fields'][]=array('id'=>$utm_source_stroke,'values'=>array(array('value'=>$utm_source)));}\n\n        if ($utm_medium){$sdelka['custom_fields'][]=array('id'=>$utm_medium_stroke,'values'=>array(array('value'=>$utm_medium)));}\n\n        if ($utm_campaign){$sdelka['custom_fields'][]=array('id'=>$utm_campaign_stroke,'values'=>array(array('value'=>$utm_campaign)));}\n\n        if ($utm_term){$sdelka['custom_fields'][]=array('id'=>$utm_term_stroke,'values'=>array(array('value'=>$utm_term)));}\n\n        if ($utm_content){$sdelka['custom_fields'][]=array('id'=>$utm_content_stroke,'values'=>array(array('value'=>$utm_content)));}\n\n  \n\n            //Устанавливаем ID поля у разных СРМ // ClientID\n\n            if($subd_amo === 'deu'){\n\n                $clientids_str = '893019';\n\n            }\n\n  \n\n            if($subd_amo === 'envo'){\n\n                $clientids_str = '543401';\n\n            }\n\n  \n\n            if($subd_amo === 'komanda1'){\n\n                $clientids_str = '2108703';\n\n            }\n\n  \n\n            if($subd_amo === 'otopitemsk'){\n\n                $clientids_str = '1157849';\n\n            }\n\n  \n\n            if($subd_amo === 'palkov'){\n\n                $clientids_str = '998577';\n\n            }\n\n            if($subd_amo === 'solgasss'){\n\n                $clientids_str = '389573';\n\n            }\n\n  \n\n        //id comment\n\n        if($subd_amo === 'palkov'){\n\n            $id_pole_comment = '991013';\n\n            if($messagelead){$sdelka['custom_fields'][]=array('id'=>$id_pole_comment,'values'=>array(array('value'=>$messagelead)));}\n\n        }\n\n  \n\n        $clientids = $_SESSION['clientid'];\n\n        if($clientids){$sdelka['custom_fields'][]=array('id'=>$clientids_str,'values'=>array(array('value'=>$clientids)));}\n\n  \n\n        $leads['request']['leads']['add'][]=$sdelka;\n\n        $link='https://'.$subd_amo.'.amocrm.ru/private/api/v2/json/leads/set';\n\n        $curl=curl_init();\n        curl_setopt($curl,CURLOPT_RETURNTRANSFER,true);\n        curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');\n        curl_setopt($curl,CURLOPT_URL,$link);\n        curl_setopt($curl,CURLOPT_CUSTOMREQUEST,'POST');\n        curl_setopt($curl,CURLOPT_POSTFIELDS,json_encode($leads));\n        curl_setopt($curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));\n        curl_setopt($curl,CURLOPT_HEADER,false);\n        curl_setopt($curl,CURLOPT_HTTPHEADER, $headers);\n        curl_setopt($curl,CURLOPT_SSL_VERIFYPEER,0);curl_setopt($curl,CURLOPT_SSL_VERIFYHOST,0);\n\n        $out=curl_exec($curl);$code=curl_getinfo($curl,CURLINFO_HTTP_CODE);\n\n        $Response=json_decode($out,true);\n\n  \n\n        session_start();\n\n        $_SESSION['id_amo'] = $Response['response']['leads']['add'][0]['id'];\n\n        $_SESSION['subd_amo'] = $subd_amo;\n\n  \n\n        if (!$code === 200){\n\n  \n\n            //Отправляется в DaewooAmoErrorBot\n\n            $text_errors = \"Ошибка при отправке лида в AMO\\nКод ошибки: \" . $code . \"\\nТело ответа: \" . serialize(curl_getinfo($curl));\n\n            sendTelegramFormErrorAmo($text_errors);\n\n  \n\n        }\n\n  \n\n        if ($code==200){\n\n            $Response=json_decode($out,true);\n\n            $Response=$Response['response']['leads']['add'];\n\n            $idsdelka=$Response[0]['id'];\n\n            if ($name==''){$name='Имя неизвестно';}\n\n            $contact=array(\n\n              'name'=>$name,\n\n              'linked_leads_id'=>array($idsdelka),\n\n              'responsible_user_id'=>$responsible_user_id\n\n            );\n\n  \n\n            //Устанавливаем ID поля у разных СРМ\n\n            if($subd_amo === 'deu'){\n\n                $id_pole_tel = '393709';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'envo'){\n\n                $id_pole_tel = '402265';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'komanda1'){\n\n                $id_pole_tel = '962361';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'otopitemsk'){\n\n                $id_pole_tel = '726437';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'teplyyepoly'){\n\n                $id_pole_tel = '176223';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'oksanamajorova'){\n\n                $id_pole_tel = '70907';\n\n                $enum = 'WORK';\n\n            }\n\n  \n\n            if($subd_amo === 'metasnab2019'){\n\n                $id_pole_tel = '19621';\n\n                $enum = 'WORK';\n\n            }\n\n  \n\n            if($subd_amo === 'teplokvam'){\n\n                $id_pole_tel = '1128263';\n\n                $enum = 'WORK';\n\n            }\n\n  \n\n            if($subd_amo === 'palkov'){\n\n                $id_pole_tel = '672125';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            if($subd_amo === 'solgasss'){\n\n                $id_pole_tel = '386859';\n\n                $enum = 'MOB';\n\n            }\n\n  \n\n            //Устанавливаем ID поля у разных СРМ\n\n            if($subd_amo === 'deu'){\n\n                $id_pole_mail = '393711';\n\n            }\n\n  \n\n            if($subd_amo === 'envo'){\n\n                $id_pole_mail = '402267';\n\n            }\n\n  \n\n            if($subd_amo === 'komanda1'){\n\n                $id_pole_mail = '962363';\n\n            }\n\n  \n\n            if($subd_amo === 'otopitemsk'){\n\n                $id_pole_mail = '726439';\n\n            }\n\n  \n\n            if($subd_amo === 'teplyyepoly'){\n\n                $id_pole_mail = '176225';\n\n            }\n\n  \n\n            if($subd_amo === 'oksanamajorova'){\n\n                $id_pole_mail = '70909';\n\n            }\n\n  \n\n            if($subd_amo === 'metasnab2019'){\n\n                $id_pole_mail = '19623';\n\n            }\n\n            if($subd_amo === 'teplokvam'){\n\n                $id_pole_mail = '1128265';\n\n            }  \n\n            if($subd_amo === 'palkov'){\n\n                $id_pole_mail = '672127';\n\n            }  \n\n            if($subd_amo === 'solgasss'){\n\n                $id_pole_mail = '386861';\n\n            }\n\n  \n\n  \n\n            if ($phone){$contact['custom_fields'][]=array('id'=>$id_pole_tel,'values'=>array(array('value'=>$phone,'enum'=>$enum)));}\n\n            if(!$email){}else{$contact['custom_fields'][]=array('id'=>$id_pole_mail,'values'=>array(array('value'=>$email,'enum'=>'WORK')));}\n\n  \n\n            $set['request']['contacts']['add'][] = $contact;\n\n  \n\n            $link='https://' . $subd_amo.'.amocrm.ru/private/api/v2/json/contacts/set';\n\n            $curl=curl_init();\n\n            curl_setopt($curl,CURLOPT_RETURNTRANSFER,true);\n\n            curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');\n\n            curl_setopt($curl,CURLOPT_URL,$link);\n\n            curl_setopt($curl,CURLOPT_CUSTOMREQUEST,'POST');\n\n            curl_setopt($curl,CURLOPT_POSTFIELDS,json_encode($set));\n\n            curl_setopt($curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));\n\n            curl_setopt($curl,CURLOPT_HEADER,false);\n\n            curl_setopt($curl,CURLOPT_HTTPHEADER, $headers);\n\n            curl_setopt($curl,CURLOPT_SSL_VERIFYPEER,0);curl_setopt($curl,CURLOPT_SSL_VERIFYHOST,0);\n\n            $out=curl_exec($curl);\n\n            $code=curl_getinfo($curl,CURLINFO_HTTP_CODE);\n\n  \n\n            if ($comments){\n\n                $notes['request']['notes']['add']=array(\n\n                array(\n\n                    'element_id'=>$idsdelka,\n\n                    'element_type'=>2,\n\n                    'note_type'=>4,\n\n                    'text'=>$comments,\n\n                    'responsible_user_id'=>$responsible_user_id,\n\n                ));\n\n  \n\n                $link='https://'.$subd_amo.'.amocrm.ru/private/api/v2/json/notes/set';\n\n                $curl=curl_init();\n\n                curl_setopt($curl,CURLOPT_RETURNTRANSFER,true);\n\n                curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');\n\n                curl_setopt($curl,CURLOPT_URL,$link);\n\n                curl_setopt($curl,CURLOPT_CUSTOMREQUEST,'POST');\n\n                curl_setopt($curl,CURLOPT_POSTFIELDS,json_encode($notes));\n\n                curl_setopt($curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));\n\n                curl_setopt($curl,CURLOPT_HEADER,false);\n\n                curl_setopt($curl,CURLOPT_HTTPHEADER, $headers);\n\n                curl_setopt($curl,CURLOPT_SSL_VERIFYPEER,0);curl_setopt($curl,CURLOPT_SSL_VERIFYHOST,0);$out4=curl_exec($curl);$code=curl_getinfo($curl,CURLINFO_HTTP_CODE);curl_close($curl);\n\n            }\n\n        } else {\n\n            $fp=fopen($_SERVER[\"DOCUMENT_ROOT\"].\"/amonew/log.txt\",\"a+\");\n\n            $rzlt = date(\"d.m.y H:i\").';'.$Response['response']['error'].';'.$_POST[\"phone\"].';'.$_POST[\"email\"].';'.$_POST[\"name\"].';'.$_POST[\"a_city\"].';;;'.urldecode($_SERVER[HTTP_REFERER]).';'.$_SERVER[HTTP_X_REAL_IP].\"\\n\";\n\n            $rzlt = str_replace(\"\\n\",'',$rzlt);\n\n            $rzlt = str_replace(chr(13),'',$rzlt);\n\n            $rzlt = str_replace(chr(10),'',$rzlt);\n\n            fwrite($fp,$rzlt.\"\\n\");\n\n            fclose($fp);\n\n        }\n\n}\n```","id":"3697a6fc0600a9b8","x":8601,"y":-7520,"width":4080,"height":13640,"color":"1"},
		{"type":"text","text":"90 - id инфоблока XL PIPE | Города\n359 - id инфоблока XL PIPE | Управление общим контентом\n```php\n$dataPROPS = getDataForCity(90,$domain,'PROPS');\n\n$generaldata = getGeneralContent(359);\n\n$city = $dataFIELDS['NAME'];\n```","id":"e2458363a88bfb2c","x":-5560,"y":-6983,"width":748,"height":268},
		{"type":"file","file":"attachments/Pasted image 20230731164914.png","id":"ed7c8c776502fc15","x":-5140,"y":-9988,"width":1396,"height":382},
		{"type":"file","file":"attachments/Pasted image 20230731164719.png","id":"955592d69d30fda3","x":-3744,"y":-11206,"width":746,"height":2436},
		{"type":"file","file":"attachments/Pasted image 20230731161549.png","id":"b4bd86fa87563579","x":-5180,"y":-10700,"width":1436,"height":665},
		{"type":"text","text":"Данная функция с именем `getGeneralContent` предположительно получает свойства элементов из указанного информационного блока.\n\nВходной параметр:\n- `$id_inf`: ID информационного блока.\n\nФункция использует API Битрикс (Bitrix), в частности, класс `CIBlockElement`, для выполнения запроса на получение списка элементов из информационного блока и получения свойств каждого элемента.\n\nФункция выполняет следующие шаги:\n1. Устанавливает список полей для выборки (`$arSelect`), который включает `ID`, `IBLOCK_ID`, `NAME`, `CODE` и `PROPERTY_*` (все свойства элемента).\n2. Устанавливает фильтр выборки (`$arFilter`), используя переданный идентификатор информационного блока (`IBLOCK_ID`).\n3. Выполняет запрос к информационному блоку с использованием метода `GetList` класса `CIBlockElement`, передавая установленные параметры выборки и фильтрации.\n4. В цикле while проходит по результатам выборки с помощью метода `GetNextElement`, получая объект элемента информационного блока (`$ob`).\n5. Получает поля элемента с помощью метода `GetFields` объекта элемента и свойства элемента с помощью метода `GetProperties`.\n6. Сохраняет полученные поля в массив `$arFields` и свойства в массив `$arProps`.\n7. Записывает массив свойств в массив `$arCity` с ключом `PROPS`.\n8. Возвращает массив свойств элементов из информационного блока.\n\nТаким образом, функция позволяет получить свойства всех элементов из указанного информационного блока при помощи системы Битрикс.\n\n```php\n//Получение данных из управления общим контентом сайта\n\nfunction getGeneralContent($id_inf){\n\n  \n\n    $arSelect = Array(\"ID\", \"IBLOCK_ID\", \"NAME\", \"CODE\", \"PROPERTY_*\");\n\n    $arFilter = Array(\"IBLOCK_ID\" => $id_inf);\n\n    $res = CIBlockElement::GetList(Array(\"NAME\" => \"ASC\"), $arFilter, false, false, $arSelect);\n\n    while($ob = $res->GetNextElement()){\n\n  \n\n        $arFields = $ob->GetFields();  \n\n        $arProps = $ob->GetProperties();\n\n  \n\n        $arCity[\"FIELDS\"] = $arFields;\n\n        $arCity[\"PROPS\"] = $arProps;\n\n    }\n\n  \n\n    return $arCity[\"PROPS\"];\n\n  \n\n}\n```","id":"caf5e918339c7456","x":-2480,"y":-4880,"width":1085,"height":1840},
		{"type":"text","text":"Данная функция с именем `getDataForCity` предположительно получает данные для определенного города из указанного информационного блока по заданным параметрам. \n\nВходные параметры:\n- `$id_inf`: ID информационного блока.\n- `$city`: Код или символьный код города.\n- `$type`: Тип данных, который нужно получить (`FIELDS` - поля, `PROPS` - свойства).\n\nФункция использует API Битрикс (bitrix), в частности, класс `CIBlockElement`, для выполнения запроса к информационному блоку и получения данных о городе.\n\nФункция применяет следующие шаги:\n1. Устанавливает список полей для выборки (`$arSelect`), который включает `ID`, `IBLOCK_ID`, `NAME`, `CODE` и `PROPERTY_*` (все свойства элемента).\n2. Устанавливает фильтр выборки (`$arFilter`), используя переданный идентификатор информационного блока (`IBLOCK_ID`), активность элемента (`ACTIVE`), дату активности (`ACTIVE_DATE`) и код города (`CODE`).\n3. Выполняет запрос к информационному блоку с использованием метода `GetList` класса `CIBlockElement`, передавая установленные параметры выборки и фильтрации.\n4. В цикле while проходит по результатам выборки с помощью метода `GetNextElement`, получая объект элемента информационного блока (`$ob`).\n5. Получает поля элемента с помощью метода `GetFields` объекта элемента и свойства элемента с помощью метода `GetProperties`.\n6. Сохраняет полученные поля и свойства в массив `$arCity` с ключами `FIELDS` и `PROPS` соответственно.\n7. Возвращает либо массив полей, либо массив свойств, в зависимости от заданного типа данных (`$type`).\n\nВ итоге, функция позволяет получить одну или оба типа данных (поля и свойства) для заданного города из информационного блока, используя систему Битрикс.\n```php\n//Получение данных о городе из инфоблока города, общая функция\n\n\nfunction getDataForCity($id_inf,$city,$type){\n\n  \n\n    $arSelect = Array(\"ID\", \"IBLOCK_ID\", \"NAME\", \"CODE\", \"PROPERTY_*\");\n\n    $arFilter = Array(\"IBLOCK_ID\" => $id_inf, \"ACTIVE_DATE\" => \"Y\", \"ACTIVE\" => \"Y\", \"CODE\" => $city);\n\n    $res = CIBlockElement::GetList(Array(\"NAME\" => \"ASC\"), $arFilter, false, false, $arSelect);\n\n    while($ob = $res->GetNextElement()){\n\n  \n\n        $arFields = $ob->GetFields();  \n\n        $arProps = $ob->GetProperties();\n\n        $arCity[\"FIELDS\"] = $arFields;\n\n        $arCity[\"PROPS\"] = $arProps;\n\n    }\n\n  \n\n    if($type === 'FIELDS'){ return $arCity[\"FIELDS\"]; }\n\n    if($type === 'PROPS'){ return $arCity[\"PROPS\"] ; }\n\n  \n  \n\n}\n```","id":"0f90e8b6bc8b5afa","x":-2480,"y":-2940,"width":1156,"height":1920},
		{"type":"text","text":"\nПолучение данных из управления общим контентом сайта\nДанная функция \"getGeneralSettingAmo\" осуществляет следующее:\n1. Принимает один параметр \"$sub_amob\", который предполагается быть названием элемента инфоблока.\n2. Формирует выборку элементов инфоблока с указанным ID \"360\" и активными элементами, имеющими заданное название \"$sub_amob\".\n3. Получает свойства и поля каждого найденного элемента.\n4. Возвращает массив свойств найденного элемента.\n\nФункция предполагает использование библиотеки \"CIBlockElement\" и необходимость работы с инфоблоками на платформе Bitrix.\n\nИнфоблок 360 это инфоблок для настройки интеграции с АМО\n\n```php\nfunction getGeneralSettingAmo($sub_amob){\n\n    $arSelectb = Array(\"ID\", \"IBLOCK_ID\", \"NAME\", \"CODE\", \"PROPERTY_*\");\n\n    $arFilterb = Array(\"IBLOCK_ID\" => 360, \"ACTIVE\" => \"Y\", \"NAME\" => $sub_amob);\n\n    \n    /*GetList возвращает список элементов по фильтру.\n\t\"ASC\" в данном контексте означает \"по возрастанию\" (от английского \"ascending\"). Это используется как параметр сортировки при вызове функции `CIBlockElement::GetList()`, указывая, что элементы должны быть отсортированы по возрастанию значения в указанном поле (в данном случае поле \"NAME\").*/\n    $resb = CIBlockElement::GetList(Array(\"NAME\" => \"ASC\"), $arFilterb, false, false, $arSelectb);\n\n/*\"obb\" не представляет собой стандартное ключевое слово или сокращение в PHP, поэтому здесь предполагается, что \"obb\" является произвольной переменной, которая используется в данном контексте. Она может представлять объект, полученный при вызове метода \"GetNextElement()\" или любую другую переменную, которая используется внутри цикла while для обработки результатов выборки из инфоблока.*/\n\n    while($obb = $resb->GetNextElement()){\n\n        $arFieldsb = $obb->GetFields();  \n\n        $arPropsb = $obb->GetProperties();\n\n        $arCityb[\"FIELDS\"] = $arFieldsb;\n\n        $arCityb[\"PROPS\"] = $arPropsb;\n\n    }\n\n    return $arCityb[\"PROPS\"];\n}\n```","id":"bbad12c6ee0d9993","x":-760,"y":-10200,"width":1160,"height":1300},
		{"type":"text","text":"\n```php\n//Функция подготовки данных для отправки в АМОСРМ и отправка собстенно лида в СРМ\n\nfunction preparationAMO($city,$user_email,$user_phone,$user_city,$subject,$user_type,$message_comment,$user_name,$dataPROPS,$generaldata){\n\n    //Город\n\n    $boss_city = $city;\n\n    $citylead = $city;\n\n    //Эмаил\n\n    $boss_email = $user_email;\n\n    //Телефон\n\n    $phone = $user_phone;\n\n    //Парсим УТМ из HTTP_REFERER(страница, с которой перешли на наш сайт)\n\n    $utm_metka_dirty = parse_url($_SERVER['HTTP_REFERER']);\n\t//Парсим в массив $utm_metka \n    parse_str($utm_metka_dirty['query'], $utm_metka);\n\n  \n\n    $utm_source = $utm_metka['utm_source'];\n\n    $utm_medium = $utm_metka['utm_medium'];\n\n    $utm_campaign = $utm_metka['utm_campaign'];\n\n    $utm_term = $utm_metka['utm_term'];\n\n    $utm_content = $utm_metka['utm_content'];\n\n\t//Проверяем есть ли в городе дилер, если есть, то \n\n    if($dataPROPS[\"DILER_Y\"][\"VALUE\"] === 'Y' or $dataPROPS[\"DILER_Y\"][\"VALUE\"] === 'да' or $dataPROPS[\"DEALER_Y\"][\"VALUE\"] === 'Y'){\n\n        //Включение/выключение интеграции:\n\n        $add_integrations_amo = $dataPROPS[\"AMO_ADD\"][\"VALUE\"];  \n\n       //Субдомен AMO(в данном случае nf812):\n\n        $subd_amo = $dataPROPS[\"AMO_AKK\"][\"VALUE\"];\n\n        //Подключаемся и получаем настройки амо\n\n        $amo_data = getGeneralSettingAmo($subd_amo);\n\n        if(mb_strtolower($utm_medium) === 'promktl'){\n\n            //ID воронки отправки\n\n            $status_id = '11051334';\n\n            //ID ответственного пользователя\n\n            $responsible_user_id = '7008304';\n\n        }else{\n\n            //ID воронки отправки\n\n            $status_id = $dataPROPS[\"AMO_V_ID\"][\"VALUE\"];\n\n            //ID ответственного пользователя\n\n            $responsible_user_id = $dataPROPS[\"AMO_RES_ID\"][\"VALUE\"];            \n\n        }\n\n  \n\t//если есть подключение к битрикс24, то интеграции к амо отключаем\n    }elseif($dataPROPS[\"B24INT_Y\"][\"VALUE\"] === 'Y'){\n\n        $add_integrations_amo = 'N';\n\n\t//иначе берем дефолтные значения\n    }else{\n\n        //Включение/выключение интеграции:\n\n        $add_integrations_amo = $generaldata[\"Y_AMODEF\"][\"VALUE\"];  \n\n        //Субдомен AMO:\n\n        $subd_amo = $generaldata[\"AMO_AKK_DEF\"][\"VALUE\"];\n\n        //Подключаемся и получаем настройки амо\n\n        $amo_data = getGeneralSettingAmo($subd_amo);\n\n        if(mb_strtolower($utm_medium) === 'promktl'){\n\n            //ID воронки отправки\n\n            $status_id = '11051334';\n\n            //ID ответственного пользователя\n\n            $responsible_user_id = '7008304';\n\n        }else{\n\n            //ID воронки отправки\n\n            $status_id = $generaldata[\"AMO_V_ID_DEF\"][\"VALUE\"];\n\n            //ID ответственного пользователя\n\n            $responsible_user_id = $generaldata[\"AMO_RES_ID_DEF\"][\"VALUE\"];          \n        }\n    }\n\n    $utm_source_stroke = $amo_data[\"U_SOURCE\"][\"VALUE\"];\n\n    $utm_medium_stroke = $amo_data[\"U_MEDIUM\"][\"VALUE\"];\n\n    $utm_campaign_stroke = $amo_data[\"U_CAMPAING\"][\"VALUE\"];\n\n    $utm_term_stroke = $amo_data[\"U_TERM\"][\"VALUE\"];\n\n    $utm_content_stroke = $amo_data[\"U_CONTENT\"][\"VALUE\"];\n\n\n    //Для заголовка в АМО переприсваиваем $subject\n\n    $_POST[\"subject\"] = $subject;\n\n    $_POST[\"name\"] = $user_name;\n\n  \n\n    //Эти данные берем из инфоблока Общие настройки/Настройка интеграции с АМО\n\n    //Идентификатор интеграции:\n\n    $id_amo = $amo_data['AMO_ID'][\"VALUE\"];\n\n    //Секретный ключ интеграции:\n\n    $secretkey_amo = $amo_data['AMO_KEY'][\"VALUE\"];\n\n    //Включение/выключение получения refresh токена:\n\n    $add_refresh_amo = $amo_data[\"REF_Y\"][\"VALUE\"];\n\n    //Сам refrash токен (живет либо 20 минут, либо 1 раз)\n\n    $refresh_amo = $amo_data[\"AMO_REF_TKEY\"][\"VALUE\"];\n\n  \n\n    //Данные для отправки лида\n\n    //IP лида\n\n    $iplead = $_SERVER[HTTP_X_REAL_IP];\n\n    //URL лида\n\n    $urllead = urldecode($_SERVER[HTTP_REFERER]);  \n\n    //Город лида\n\n    $citylead = $user_city;\n\n    //Имя лида\n\n    $namelead = $user_phone.\", \".$subject;\n\n    //Тэги\n\n    $tag = $_SERVER['HTTP_HOST'];\n\n  \n\n    //Комментарии\n\n    $comments = $message_comment;\n\n  \n  \n\n    if(!$utm_metka['utm_source']){\n\n        $source = 'rk_BezReklamy';\n\n    }else{\n\n        $source = 'rk_' . $utm_metka['utm_source'] . ',';\n\n    }\n\n  \n\n    if(!$utm_metka['utm_medium']){\n\n        $medium = '';\n\n    }else{\n\n        $medium = 'g_' . $utm_metka['utm_medium'] . ',';\n\n    }\n\n  \n\n    if(!$utm_metka['utm_campaign']){\n\n        $campaign = '';\n\n    }else{\n\n        $campaign = 'k_' . $utm_metka['utm_campaign'] . ',';  \n\n    }\n\n  \n\n    if(!$utm_metka['utm_content']){\n\n        $content = '';\n\n    }else{\n\n        $content = 'ad_' . $utm_metka['utm_content'] . ',';    \n\n    }\n\n  \n\n    $rk = ',' . $source . $medium . $campaign . $content;\n\n  \n  \n\n    $s_tags = 'oA2,' . $boss_city . $rk . ',' . idn_to_utf8($_SERVER['HTTP_HOST']);\n\n    if ($add_integrations_amo == 'Y') { require(\"/home/admin/web/centr-polov.ru/public_html/upload/amo_integration/control_integration.php\"); }\n\n}\n```\n","id":"6c0001010b702940","x":-2480,"y":-11480,"width":1560,"height":6520,"color":"1"}
	],
	"edges":[
		{"id":"16b7b2e4014eeee3","fromNode":"d40f94022dbd653e","fromSide":"bottom","toNode":"677bf3139db6fd8e","toSide":"top"},
		{"id":"3573a1ab971cef1c","fromNode":"2d6c4c134b921da2","fromSide":"top","toNode":"63c8819e09173d40","toSide":"bottom","label":"gettingRefreshTokenAmo();"},
		{"id":"3c5ce8c7bced9bff","fromNode":"c39630510efe853c","fromSide":"top","toNode":"63c8819e09173d40","toSide":"bottom","label":"gettingAccessTokenAmo();"},
		{"id":"a3bed3488b3f93df","fromNode":"bbad12c6ee0d9993","fromSide":"left","toNode":"6c0001010b702940","toSide":"right"},
		{"id":"3540ed2e4500697b","fromNode":"63c8819e09173d40","fromSide":"right","toNode":"1e2f057bcc870e21","toSide":"left","color":"1"},
		{"id":"c7ee8898b31224d4","fromNode":"6c0001010b702940","fromSide":"right","toNode":"63c8819e09173d40","toSide":"left","color":"1"},
		{"id":"836cfdc9a6a1f70c","fromNode":"677bf3139db6fd8e","fromSide":"right","toNode":"6c0001010b702940","toSide":"left","color":"1"},
		{"id":"168b7f2d5c0003f9","fromNode":"7e04312a3e8a8c13","fromSide":"right","toNode":"677bf3139db6fd8e","toSide":"left"},
		{"id":"0083da54bb1c5379","fromNode":"7e04312a3e8a8c13","fromSide":"right","toNode":"d40f94022dbd653e","toSide":"left"},
		{"id":"d2f13047694c46d5","fromNode":"e2458363a88bfb2c","fromSide":"bottom","toNode":"677bf3139db6fd8e","toSide":"top"},
		{"id":"982881be829ae76c","fromNode":"0f90e8b6bc8b5afa","fromSide":"left","toNode":"e2458363a88bfb2c","toSide":"right","label":"getDataForCity();"},
		{"id":"d800e43a613079cf","fromNode":"caf5e918339c7456","fromSide":"left","toNode":"e2458363a88bfb2c","toSide":"right","label":"getGeneralContent();"},
		{"id":"99568171e16d366b","fromNode":"2d6c4c134b921da2","fromSide":"bottom","toNode":"b00018ae4b2fda6e","toSide":"top","label":"writeJsonToFilesAmoCR();"},
		{"id":"8f7bede6248c2c94","fromNode":"2d6c4c134b921da2","fromSide":"bottom","toNode":"6cb52bdcb38d70f0","toSide":"top","label":"sendTelegramFormErrorAmo();"},
		{"id":"e7826537f3e222a0","fromNode":"c39630510efe853c","fromSide":"bottom","toNode":"b00018ae4b2fda6e","toSide":"top","label":"writeJsonToFilesAmoCR();"},
		{"id":"045f7e4020f6f670","fromNode":"c39630510efe853c","fromSide":"bottom","toNode":"6cb52bdcb38d70f0","toSide":"top","label":"sendTelegramFormErrorAmo();"},
		{"id":"1ebcb494f8b387bf","fromNode":"1e2f057bcc870e21","fromSide":"right","toNode":"ac29084e67f2a107","toSide":"left","color":"1"},
		{"id":"17f1f2dd767c4c5e","fromNode":"3697a6fc0600a9b8","fromSide":"top","toNode":"1e2f057bcc870e21","toSide":"bottom"}
	]
}